# 성적분석 기능 개발 문서

> **대상**: 경찰 합격예측 프로그램 — `/exam/result` 페이지 성적분석 탭
> **직렬**: 공채 (헌법+형사법+경찰학) / 경행경채 (범죄학+형사법+경찰학)
> **작성일**: 2026-02-21

---

## 1. 개요

응시자가 OMR 답안을 입력한 뒤 받을 수 있는 **성적분석 기능**을 정의한다.
경단기·해커스·윌비스 등 경쟁사 풀서비스와 제공된 참고 이미지(성적분석, 오답률 Top5, 문항 채점표, 과목별 평균 차트)를 기반으로 설계하였다.

### 참고 자료
- 제공된 스크린샷 6장 (성적분석 테이블, 과목별 평균 차트, 오답률 Top5, 개인 성적분석, 문항 채점표)
- [경단기 풀서비스](https://fullservice.conects.com/conects/P250315_1/main) — 채점/성적분석/합격예측 올인원
- [해커스경찰 합격예측](https://fullservice.hackers.com/?fullservice_code=FP25031501) — 과목별 성적, 석차, 오답률 분석
- [에듀윌 경찰 풀서비스](https://brand.eduwill.net/event/fullService/full_cop_after.will) — 자동채점/성적분석/합격예측
- [EBSi 오답률 분석](https://www.ebsi.co.kr/ebs/xip/xipa/retrievePastGrdCutWrongAnswerRate.ebs?tab=1) — 역대 등급컷/오답률 UI 참고

---

## 2. 기존 `/exam/result` 페이지 현황

> **중요**: 아래 기능들은 이미 구현되어 운영 중. 신규 기능은 이들과 중복 없이 **확장 또는 대체**해야 함.

### 기존 컴포넌트 목록

| # | 기존 컴포넌트 | 위치 | 표시 데이터 | 신규 기능과의 관계 |
|---|-------------|------|-----------|-----------------|
| ① | **Summary Cards** (4개) | `page.tsx:243-264` | 원점수, 최종점수, 전체석차, 백분위 | → **[A]에 통합** (최고점/상위% 열 추가) |
| ② | **내 과목별 원점수 바차트** | `page.tsx:266-294` | 과목별 내 원점수 BarChart | → **[A]에 유지** + [B]와 병합 가능 (내 점수 vs 평균 비교) |
| ③ | **상세 분석 테이블** | `page.tsx:297-365` | 원점수/백분위/석차÷참여자/과락 (총점+과목별) | → **[A]에 통합** (열 추가: 최고점, 상위10%, 상위30%) |
| ④ | **과락 경고** | `page.tsx:367-379` | 과락 과목 목록 (조건부 표시) | → **[A] 내 유지** |
| ⑤ | **CorrectRateChart** | `CorrectRateChart.tsx` | 과목별 문항 정답률 바차트 (드롭다운) + 내 정오 색상 | → **유지**: 서브탭3(정오표)에서 문항별 정답률 시각화 |
| ⑥ | **AnswerSheet** | `AnswerSheet.tsx` | 번호/내답/정답/결과/정답률/난이도 테이블 + 과목요약 | → **2열 레이아웃으로 개선** (기존 컴포넌트 수정) |
| ⑦ | **가산점 요약** | `page.tsx:384-394` | 원점수+가산점+최종점수 계산 요약 | → **[A] 내 유지** |
| ⑧ | **액션 버튼** | `page.tsx:396-419` | 답안수정/최종환산/합격예측 버튼 | → **페이지 하단 유지** |

### 기존 API 응답 데이터 (`GET /api/result`)

```
이미 포함: submission(점수/가산점), scores[](과목별 원점수/석차/백분위/정답률/답안),
          subjectCorrectRateSummaries(과목평균정답률/hardest/easiest),
          statistics(총석차/총백분위/과락여부)

미포함(신규 필요): 전체 평균, 최고점, 상위10%평균, 상위30%평균,
                  점수대별 분포, 정답변경 이력
```

---

## 3. 기능 목록 요약

| # | 기능명 | 설명 | 구현 방식 |
|---|--------|------|---------|
| A | **전체 성적 요약** (확장) | 기존 Summary Cards + 상세 분석 테이블을 통합 확장. **전체 평균·최고점·상위10%·30% 평균** 열 추가 | 기존 수정 |
| B | **과목별 비교 차트** | 기존 내 점수 바차트에 **전체 평균을 그룹 막대**로 추가 (내 점수 vs 전체 평균) | 기존 수정 |
| C | **오답률 Top5** | 과목별 드롭다운으로 선택, 오답률 높은 문항 5개 | **신규** |
| F | **점수대별 인원 분포** | 10점 구간 히스토그램 (내 위치 강조) | **신규** |
| J | **정답 변경 영향 분석** | 가답안→확정답안 변경 시 점수·석차 변동 비교 (변경 전/후) | **신규** |
| K | **참여 현황** | 현재 참여자 수 + 내 현재 석차/백분위 실시간 갱신 | **신규** |

> **제거된 기능**:
> - D(문항별 정답률 표), E(문항 채점표): 기존 CorrectRateChart·AnswerSheet와 중복 → 기존 컴포넌트 개선으로 대체
> - G(정답률 히트맵): 경쟁사 미제공 + 모바일 가독성 불량 + C(오답률 Top5)가 대체
> - H(오답 패턴 분석): 합격예측 본질과 거리 + 운영 부담 → 2차 출시 검토
> - I(난이도 비교 대시보드): 과목 3개로 레이더차트 무의미 + A 테이블의 전체 평균으로 대체

---

## 4. 기능별 상세 명세

### A. 전체 성적 요약 테이블 (기존 확장)

> 기존 Summary Cards(4개) + 상세 분석 테이블(원점수/백분위/석차/과락)을 **하나로 통합**하고,
> **전체 평균·최고점·상위10%·상위30% 평균** 열을 추가한 확장 버전.
> *(I 과목 난이도 비교 대시보드 제거 → 전체 평균 열이 난이도 판단 역할 대체)*
>
> 참고 이미지: 4번째 스크린샷 (개인 성적분석)
>
> **기존 제거 대상**: ① Summary Cards 4개, ③ 상세 분석 테이블, ④ 과락 경고, ⑦ 가산점 요약 → 모두 A에 통합

#### UI 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ ● 성적분석                                                                   │
├─────────┬──────────┬──────────┬─────────┬────────┬──────────┬──────────┤
│ 과목명   │  내 점수  │내석차/응시│전체 평균 │ 최고점  │상위10%평균│상위30%평균│
├─────────┼──────────┼──────────┼─────────┼────────┼──────────┼──────────┤
│ 형사법   │80.0/100.0│ 82 / 286 │  67.5   │ 100.0  │   93.5   │   87.2   │
│ 경찰학   │77.5/100.0│ 65 / 286 │  60.8   │  95.0  │   88.0   │   82.7   │
│ 헌법     │37.5/50.0 │135 / 279 │  35.1   │  50.0  │   46.5   │   44.8   │
├─────────┼──────────┼──────────┼─────────┼────────┼──────────┼──────────┤
│ 총계     │195.0/250 │ 80 / 286 │ 163.4   │ 245.0  │  228.0   │  214.7   │
└─────────┴──────────┴──────────┴─────────┴────────┴──────────┴──────────┘
```

#### 데이터 구조

```typescript
interface SubjectAnalysis {
  subjectId: number;
  subjectName: string;        // "형사법", "경찰학", "헌법" 또는 "범죄학"
  myScore: number;            // 내 원점수
  maxScore: number;           // 과목 만점 (50 또는 100)
  myRank: number;             // 해당 과목 석차
  totalParticipants: number;  // 동일 시험+지역+채용유형 응시인원
  averageScore: number;       // 전체 평균 점수 (난이도 판단 기준 — I 대시보드 대체)
  highestScore: number;       // 과목 최고점
  top10Average: number;       // 상위 10% 평균
  top30Average: number;       // 상위 30% 평균
}

interface GradeAnalysisSummary {
  examType: 'PUBLIC' | 'CAREER';  // 공채 / 경행경채
  subjects: SubjectAnalysis[];
  total: {
    myScore: number;
    maxScore: number;           // 250
    myRank: number;
    totalParticipants: number;
    averageScore: number;       // 전체 평균 총점
    highestScore: number;
    top10Average: number;
    top30Average: number;
  };
}
```

#### 직렬별 과목 표시

| 채용유형 | 과목 열 순서 |
|---------|------------|
| **공채** | 형사법, 경찰학, 헌법 |
| **경행경채** | 형사법, 경찰학, 범죄학 |

#### 필요한 DB 쿼리 (신규)

```sql
-- 과목별 전체 평균, 최고점, 상위 10% 평균, 상위 30% 평균
SELECT
  ss.subjectId,
  ROUND(AVG(ss.rawScore), 1) AS averageScore,
  MAX(ss.rawScore) AS highestScore,
  -- 상위 10% 평균
  (SELECT AVG(sub.rawScore)
   FROM SubjectScore sub
   INNER JOIN Submission s2 ON sub.submissionId = s2.id
   WHERE s2.examId = ? AND s2.examType = ? AND sub.subjectId = ss.subjectId
   ORDER BY sub.rawScore DESC
   LIMIT FLOOR(COUNT(*) * 0.1)) AS top10Avg,
  -- 상위 30% 평균
  (SELECT AVG(sub.rawScore)
   FROM SubjectScore sub
   INNER JOIN Submission s2 ON sub.submissionId = s2.id
   WHERE s2.examId = ? AND s2.examType = ? AND sub.subjectId = ss.subjectId
   ORDER BY sub.rawScore DESC
   LIMIT FLOOR(COUNT(*) * 0.3)) AS top30Avg
FROM SubjectScore ss
INNER JOIN Submission s ON ss.submissionId = s.id
WHERE s.examId = ? AND s.examType = ?
GROUP BY ss.subjectId;
```

> **구현 참고**: 상위 N% 평균은 MySQL 8.x의 윈도우 함수 `NTILE()` 또는 `PERCENT_RANK()`를 활용하면 단일 쿼리로 효율적 산출 가능.

---

### B. 과목별 비교 차트 (기존 수정)

> 기존 ② 내 과목별 원점수 바차트를 **그룹 막대(내 점수 vs 전체 평균)**로 개선.
> 참고 이미지: 2번째 스크린샷 (과목별 평균성적 바 차트)
>
> **기존 제거 대상**: ② 내 과목별 원점수 바차트 → B로 대체

#### UI 레이아웃

- **차트 타입**: Recharts `BarChart` — **그룹 막대** (과목당 2개 막대)
- **X축**: 과목명 (공채: 형사법, 경찰학, 헌법 / 경행경채: 형사법, 경찰학, 범죄학)
- **Y축**: 점수 (0 ~ 과목만점)
- **막대 1**: 내 점수 — 파란색 (#2563eb)
- **막대 2**: 전체 평균 — 연한 초록색 (#8BC34A)
- **범례**: "내 점수" / "전체 평균"
- **막대 위**: 점수 값 표시

#### 데이터 구조

```typescript
interface SubjectComparisonChart {
  subjectName: string;
  myScore: number;             // 내 원점수 (기존 데이터)
  averageScore: number;        // 전체 응시자 평균 (신규 데이터)
  maxPossible: number;         // 과목 만점 (스케일 기준)
}
```

#### 기존과의 차이

| 항목 | 기존 (내 원점수 바차트) | 개선 (B) |
|------|---------------------|---------|
| 막대 수 | 과목당 1개 (내 점수) | 과목당 **2개** (내 점수 + 전체 평균) |
| 비교 가능 | 내 과목 간 비교만 | 내 점수 vs **다른 사람 평균** 비교 |
| 신규 API 데이터 | 불필요 | 과목별 전체 평균 (GET /api/analysis/subject-stats) |

#### 직렬별 과목 구분

- 공채 응시자끼리의 평균, 경행경채 응시자끼리의 평균을 **별도 산출**
- 화면에는 로그인한 사용자의 채용유형에 해당하는 과목만 표시

---

### C. 오답률 Top5

> 참고 이미지: 3번째 스크린샷 (오답률 Top5 테이블)

#### UI 레이아웃

```
┌─ 과목 선택 ────────────────────────────────────┐
│ [▼ 형사법  ▾]                                   │
└────────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ ● 오답률 Top5                               │
├──────┬──────┬──────┬──────┬──────┤
│ 순서  │ 과목  │ 문항  │오답률 │ 정답  │
├──────┼──────┼──────┼──────┼──────┤
│  1   │형사법│  12  │63.2% │  ③   │
│  2   │형사법│  27  │58.7% │  ④   │
│  3   │형사법│  33  │55.4% │  ①   │
│  4   │경찰학│  8   │52.1% │  ②   │
│  5   │헌법  │  19  │49.8% │  ④   │
└──────┴──────┴──────┴──────┴──────┘
```

#### 드롭다운 과목 선택

| 채용유형 | 드롭다운 옵션 |
|---------|------------|
| **공채** | 전체 / 형사법 / 경찰학 / 헌법 |
| **경행경채** | 전체 / 형사법 / 경찰학 / 범죄학 |

- "전체" 선택 시: 모든 과목 문항 중 오답률 Top5
- 과목 선택 시: 해당 과목 문항 중 오답률 Top5

#### 데이터 구조

```typescript
interface WrongAnswerTop {
  rank: number;               // 1~5
  subjectName: string;        // 과목명
  questionNumber: number;     // 문항 번호
  wrongRate: number;          // 오답률 (%) = 100 - 정답률
  correctAnswer: number;      // 정답 선지 (1~4)
}
```

#### 필요한 DB 쿼리 (신규)

```sql
-- 과목별 오답률 Top5
SELECT
  ua.subjectId,
  ua.questionNumber,
  ROUND(SUM(ua.isCorrect) * 100.0 / COUNT(*), 1) AS correctRate,
  ROUND((1 - SUM(ua.isCorrect) * 1.0 / COUNT(*)) * 100, 1) AS wrongRate,
  ak.correctAnswer
FROM UserAnswer ua
INNER JOIN Submission s ON ua.submissionId = s.id
INNER JOIN AnswerKey ak ON ak.examId = s.examId
  AND ak.subjectId = ua.subjectId
  AND ak.questionNumber = ua.questionNumber
WHERE s.examId = ? AND s.examType = ?
  AND ua.subjectId = ?  -- 과목 필터 (전체 시 제거)
GROUP BY ua.subjectId, ua.questionNumber, ak.correctAnswer
ORDER BY wrongRate DESC
LIMIT 5;
```

---

### 기존 컴포넌트 개선 사항 (D, E 대체)

> 아래 두 기존 컴포넌트는 신규 기능 D·E와 중복되므로 **별도 신규 기능을 만들지 않고 기존을 개선**한다.

#### ⑤ CorrectRateChart 개선 (기존 D 대체)

**현재**: 과목별 문항 정답률 바차트 + 내 정오 색상 + 40% 기준선
**개선 없음**: 현재 기능이 충분. 서브탭3(정오표)에서 AnswerSheet과 함께 표시.

#### ⑥ AnswerSheet 개선 → 2열 레이아웃 (기존 E 대체)

**현재**: 과목별 전체 문항 세로 1열 테이블 (번호/내답/정답/결과/정답률/난이도)
**개선 내용**:

```
변경 전 (1열):                    변경 후 (2열):
┌──────────────────┐             ┌─────────┬─────────┐
│ 1 │ 4 │ O │66.7% │             │ 1~20    │ 21~40   │
│ 2 │ 2 │ X │79.3% │             │ (좌측)  │ (우측)  │
│ ...              │             └─────────┴─────────┘
│ 40│ 1 │ O │82.3% │
└──────────────────┘
```

| 항목 | 현재 | 개선 후 |
|------|------|--------|
| 레이아웃 | 1열 (세로로 40행) | **2열** (좌: 1~20, 우: 21~40) |
| 과목 전환 | 과목별 섹션 세로 나열 | **드롭다운 선택** (한 과목씩 표시) |
| 과목 요약 | 하단 텍스트 요약 | **유지** (H 제거로 기존 요약 그대로 보존) |
| 20문항 과목 | 20행 | **2열** (좌: 1~10, 우: 11~20) |

**구현**: 기존 `AnswerSheet.tsx`를 수정 (신규 컴포넌트 생성 안 함)

> **핵심**: 기존 AnswerSheet 하단의 과목 요약(평균정답률/hardest/easiest/고난도정답수/쉬운문항오답수)은
> H(오답 패턴 분석) 제거로 인해 **기존 그대로 유지**.

---

### F. 점수대별 인원 분포 히스토그램

> 경쟁사 공통 기능 (경단기·해커스·에듀윌 풀서비스)

#### UI 레이아웃

```
● 점수대별 인원 분포

  인원
  50│          ┌──┐
  40│       ┌──┤  ├──┐
  30│    ┌──┤  │  │  ├──┐
  20│ ┌──┤  │  │  │  │  ├──┐
  10│ │  │  │  │  │  │  │  ├──┐
   0├─┴──┴──┴──┴──┴──┴──┴──┴──┴──
     ~150 160 170 180 190 200 210 220 230 240~
                      ▲
                   내 점수 (195.0)

  [내 위치: 190~200점 구간, 해당 구간 42명]
```

#### 특징
- **X축**: 10점 구간 (0~250점, 총 25개 버킷)
- **Y축**: 해당 구간 인원수
- **내 위치**: 내 점수가 속한 구간을 다른 색상으로 강조
- **기준**: 동일 시험 + 동일 채용유형 응시자 전체

#### 데이터 구조

```typescript
interface ScoreDistribution {
  bucketStart: number;        // 구간 시작점 (0, 10, 20, ...)
  bucketEnd: number;          // 구간 끝점 (10, 20, 30, ...)
  count: number;              // 해당 구간 인원수
  isMyBucket: boolean;        // 내 점수가 속한 구간 여부
}
```

#### 기존 구현 활용
- `/api/stats`에 10점 구간 25개 버킷 점수 분포가 이미 구현되어 있음 (관리자 전용)
- 사용자 대상 API로 분리하여 재활용 가능

---

---

---

### ~~I. 과목 난이도 비교 대시보드~~ (제거됨)

> **제거 사유**: 과목이 3개뿐이라 레이더차트 무의미 + 카드/테이블/누적바/레이더 4종 차트 조합은 과잉설계.
> **대체**: A(전체 성적 요약) 테이블에 "전체 평균" 열 추가로 난이도 판단 충분.
> 경쟁사(경단기/해커스/에듀윌)도 복합 난이도 대시보드 미제공.

---

### J. 정답 변경 영향 분석

> **핵심 목적**: 가답안 → 확정답안 변경 시 "내 점수와 석차가 어떻게 바뀌었는가?"를 한눈에 확인
>
> 경찰 시험 일정: 필기시험 3.14(토) → 합격발표 3.20(금), **약 6일간 가답안 상태**
> 이 기간 동안 수험생이 가장 궁금해하는 핵심 정보

#### UI 레이아웃

```
┌─────────────────────────────────────────────────────────────────────┐
│ ● 정답 변경 영향 분석                                                │
│                                                                     │
│  ┌─── 변경된 문항 ─────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  변경 일시: 2026.03.17 14:00  (사유: 확정답안 반영)              │ │
│  │                                                                 │ │
│  │  ┌────────┬────────┬──────────┬──────────┬──────────┐          │ │
│  │  │  과목   │ 문항번호 │ 변경 전   │ 변경 후   │ 내 답안   │          │ │
│  │  ├────────┼────────┼──────────┼──────────┼──────────┤          │ │
│  │  │ 형사법  │  12번   │   ②     │   ③     │ ③ ✅ 득점 │          │ │
│  │  │ 경찰학  │  27번   │   ④     │   ②     │ ④ ❌ 실점 │          │ │
│  │  │ 헌법    │   5번   │   ①     │  복수정답 │ ③ ✅ 득점 │          │ │
│  │  └────────┴────────┴──────────┴──────────┴──────────┘          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─── 내 성적 변동 ────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │          │  변경 전  │  변경 후  │   변동      │                │ │
│  │  ────────┼─────────┼─────────┼───────────  │                │ │
│  │  형사법   │  80.0점  │  82.5점  │  +2.5 ▲    │                │ │
│  │  경찰학   │  77.5점  │  75.0점  │  -2.5 ▼    │                │ │
│  │  헌법     │  37.5점  │  40.0점  │  +2.5 ▲    │                │ │
│  │  ────────┼─────────┼─────────┼───────────  │                │ │
│  │  총점     │ 195.0점  │ 197.5점  │  +2.5 ▲    │                │ │
│  │  석차     │  80등    │  72등    │  +8등 ▲    │                │ │
│  │  백분위   │  상위27% │  상위24% │  +3%p ▲    │                │ │
│  │                                                                 │ │
│  │  💡 정답 변경으로 2.5점 상승, 석차 8단계 상승했습니다.            │ │
│  │     합격 등급: 가능권 → 유력권으로 변경                          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ⚠️ 아직 정답 변경이 없습니다.                                      │
│     확정답안이 발표되면 자동으로 분석 결과가 표시됩니다.               │
└─────────────────────────────────────────────────────────────────────┘
```

#### 표시 조건

| 상태 | 표시 내용 |
|------|---------|
| 정답 변경 **없음** (가답안 유지 중) | "아직 정답 변경이 없습니다" 안내 문구 |
| 정답 변경 **있음** (확정답안 반영됨) | 변경 문항 테이블 + 성적 변동 테이블 |
| 복수 정답 처리 | 해당 문항 "복수정답"으로 표시, 모든 응시자 정답 처리 |

#### 데이터 구조

```typescript
interface AnswerChangeImpact {
  hasChanges: boolean;                // 정답 변경 여부
  rescoreEventId: number | null;      // RescoreEvent ID
  rescoreDate: string;                // 변경 일시
  reason: string;                     // 변경 사유

  // 변경된 문항 목록
  changedQuestions: {
    subjectName: string;              // 과목명
    questionNumber: number;           // 문항번호
    oldAnswer: number | null;         // 변경 전 정답
    newAnswer: number | string;       // 변경 후 정답 (복수정답 시 "복수정답")
    myAnswer: number;                 // 내 답안
    impact: 'GAINED' | 'LOST' | 'NO_CHANGE';  // 득점/실점/변동없음
  }[];

  // 성적 변동 요약
  scoreChange: {
    subjects: {
      subjectName: string;
      oldScore: number;
      newScore: number;
      delta: number;
    }[];
    oldTotalScore: number;
    newTotalScore: number;
    totalDelta: number;
    oldFinalScore: number;            // 가산점 포함
    newFinalScore: number;
    oldRank: number;
    newRank: number;
    rankDelta: number;                // 양수 = 상승
  };

  // 분석 코멘트
  analysisComment: string;
}
```

#### 기존 인프라 활용 (추가 DB 불필요)

| 기존 모델 | 역할 | 활용 방안 |
|----------|------|---------|
| `RescoreEvent` | 재채점 이벤트 메타데이터 | `summary` JSON에서 `changedQuestions[]` 추출 |
| `RescoreDetail` | 제출건별 점수 변동 | `oldTotalScore`/`newTotalScore`/`oldRank`/`newRank` 직접 조회 |
| `AnswerKeyLog` | 정답키 변경 이력 | `oldAnswer`/`newAnswer` 조회 |
| `UserAnswer` | 내 답안 | 변경 문항에 대한 내 선택지 확인 |

> **핵심**: 기존 `rescoreExam()` 함수가 재채점 시 `RescoreDetail`에 변경 전/후 점수·석차를 이미 저장하므로,
> 사용자 화면에서는 이 데이터를 **조회만 하면 됨** — 추가 계산 로직 불필요.

#### 필요한 DB 쿼리

```sql
-- 1. 최신 RescoreEvent 조회
SELECT re.id, re.examType, re.reason, re.summary, re.createdAt
FROM RescoreEvent re
WHERE re.examId = ?
ORDER BY re.createdAt DESC
LIMIT 1;

-- 2. 해당 사용자의 RescoreDetail 조회
SELECT rd.oldTotalScore, rd.newTotalScore, rd.oldFinalScore, rd.newFinalScore,
       rd.oldRank, rd.newRank, rd.scoreDelta
FROM RescoreDetail rd
WHERE rd.rescoreEventId = ? AND rd.userId = ?;

-- 3. 변경된 문항에 대한 내 답안 조회
SELECT ua.subjectId, ua.questionNumber, ua.selectedAnswer, ua.isCorrect
FROM UserAnswer ua
INNER JOIN Submission s ON ua.submissionId = s.id
WHERE s.examId = ? AND s.userId = ?
  AND (ua.subjectId, ua.questionNumber) IN (/* changedQuestions 목록 */);
```

---

### K. 참여 현황

> **핵심 목적**: 현재 참여자 수와 내 석차/백분위를 실시간으로 보여줌
>
> 수험생 재방문율을 높이는 핵심 기능 — "지금 내 등수는?"을 확인하러 반복 접속
>
> *(석차 변동 시계열 그래프는 1차 출시 범위에서 제외 — 접속할 때마다 현재 석차 갱신이면 충분)*

#### UI 레이아웃

```
┌─────────────────────────────────────────────────────────────────────┐
│ ● 참여 현황                                                         │
│                                                                     │
│  ┌─── 현재 참여 현황 ──────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  현재 참여자: 596명 (공채 기준)                                  │ │
│  │  내 현재 석차: 80등 (상위 13.4%)                                 │ │
│  │  마지막 업데이트: 2026.03.16 15:30                               │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  💡 참여자가 늘어나면 석차가 변동될 수 있습니다.                      │
│     페이지를 다시 방문하면 최신 석차로 자동 갱신됩니다.               │
└─────────────────────────────────────────────────────────────────────┘
```

#### 구현 방식

- 별도 API 불필요 — 기존 `GET /api/result`가 이미 현재 석차·참여자수·백분위를 반환
- 결과 페이지 방문 시마다 최신 데이터로 표시 (별도 스냅샷 저장 불필요)
- 신규 DB 모델 불필요 (RankSnapshot 제거)

#### 데이터 구조

```typescript
interface ParticipantStatus {
  currentRank: number;            // 내 현재 석차
  totalParticipants: number;      // 동일 시험+지역+채용유형 참여자 수
  percentile: number;             // 상위 비율 (%)
  lastUpdated: string;            // 마지막 갱신 시점
}
```

#### 기존 인프라 활용

| 기존 자원 | 활용 방안 |
|----------|---------|
| `GET /api/result` | 이미 석차·참여자수·백분위 포함 — 추가 API 불필요 |
| `PassCutSnapshot.participantCount` | 관리자 릴리스 시점의 참여자 수 참고 |

---

## 4. API 엔드포인트 설계

### 4.1 기존 API 활용 (수정 필요)

| API | 현재 상태 | 추가 필요 항목 |
|-----|---------|-------------|
| `GET /api/result` | 구현됨 | 과목별 전체 평균, 최고점, 상위10%·30% 평균 추가 |
| `GET /api/stats` | 관리자 전용 | 점수대별 분포를 사용자 API로 분리 |

### 4.2 신규 API

#### `GET /api/analysis/subject-stats`

과목별 통계 (최고점, 평균, 상위 N% 평균)

```
Query: ?examId={}&examType=PUBLIC|CAREER
Response: {
  success: true,
  data: {
    subjects: SubjectAnalysis[],
    total: { ... }
  }
}
```

#### `GET /api/analysis/wrong-rate-top`

오답률 Top5

```
Query: ?examId={}&examType=PUBLIC|CAREER&subjectId={선택적}
Response: {
  success: true,
  data: WrongAnswerTop[]
}
```

#### `GET /api/analysis/score-distribution`

점수대별 인원 분포

```
Query: ?examId={}&examType=PUBLIC|CAREER
Response: {
  success: true,
  data: ScoreDistribution[]
}
```

#### `GET /api/analysis/answer-change-impact`

정답 변경 영향 분석 (가답안→확정답안 변경 시 점수·석차 변동)

```
Query: ?examId={}&userId={}
Response: {
  success: true,
  data: AnswerChangeImpact
}
```

> **구현 참고**: `RescoreEvent` + `RescoreDetail` + `AnswerKeyLog` 조회만으로 구성 — 추가 계산 불필요

> **K(참여 현황)**: 별도 API 불필요 — 기존 `GET /api/result`가 석차·참여자수·백분위를 이미 반환

---

## 5. 컴포넌트 구조

```
src/app/exam/result/
├── page.tsx                            # 결과 페이지 — 서브탭 상태 관리 (기존 수정)
│
├── components/
│   ├── AnalysisSubTabs.tsx             # 서브탭 네비게이션 (필 버튼 3개) [신규]
│   │
│   ├── tabs/                           # 서브탭별 컨테이너 [신규]
│   │   ├── MyScoreTab.tsx              # 서브탭1: 내 성적 (A + J + K)
│   │   ├── ExamAnalysisTab.tsx         # 서브탭2: 시험 분석 (B + C + F)
│   │   └── AnswerReviewTab.tsx         # 서브탭3: 정오표 (기존CorrectRateChart + 기존AnswerSheet)
│   │
│   ├── GradeAnalysisTable.tsx          # [A] 전체 성적 요약 (기존 cards+table 통합) [신규]
│   ├── AnswerChangeImpact.tsx          # [J] 정답 변경 영향 분석 [신규]
│   ├── ParticipantStatus.tsx           # [K] 참여 현황 (참여자수+석차+백분위) [신규]
│   ├── SubjectComparisonChart.tsx      # [B] 과목별 비교 차트 (기존 바차트 대체) [신규]
│   ├── WrongRateTop5.tsx               # [C] 오답률 Top5 [신규]
│   └── ScoreDistributionChart.tsx      # [F] 점수대별 인원 분포 [신규]
│
src/components/result/
├── CorrectRateChart.tsx                # [기존 유지] 문항별 정답률 바차트
└── AnswerSheet.tsx                     # [기존 수정] 2열 레이아웃 개선
```

### 기존 page.tsx에서 제거되는 코드

| 기존 코드 영역 | 라인 | 처리 |
|---------------|------|------|
| Summary Cards (4개) | 243-264 | → [A] GradeAnalysisTable로 통합 |
| 내 원점수 바차트 | 266-294 | → [B] SubjectComparisonChart로 대체 |
| 상세 분석 테이블 | 297-365 | → [A] GradeAnalysisTable로 통합 |
| 과락 경고 | 367-379 | → [A] GradeAnalysisTable 내 포함 |
| 가산점 요약 | 384-394 | → [A] GradeAnalysisTable 하단 포함 |
| CorrectRateChart 호출 | 381 | → 서브탭3(AnswerReviewTab) 내로 이동 |
| AnswerSheet 호출 | 382 | → 서브탭3(AnswerReviewTab) 내로 이동 |
| 액션 버튼 | 396-419 | → 서브탭 영역 아래 유지 |

### 컴포넌트 계층 구조

```
page.tsx (기존 수정)
  ├── Header (시험명/연도/유형 — 기존 유지)
  │
  └── AnalysisSubTabs (서브탭 UI + 상태 관리)
  │     ├── MyScoreTab (기본 활성)
  │     │     ├── GradeAnalysisTable       [A] (기존 cards+table+과락+가산점 통합)
  │     │     ├── AnswerChangeImpact       [J] (조건부)
  │     │     └── ParticipantStatus        [K] (참여자수+석차+백분위)
  │     ├── ExamAnalysisTab
  │     │     ├── SubjectComparisonChart   [B] (기존 바차트 대체)
  │     │     ├── WrongRateTop5            [C]
  │     │     └── ScoreDistributionChart   [F]
  │     └── AnswerReviewTab
  │           ├── CorrectRateChart         (기존 유지)
  │           └── AnswerSheet              (기존 → 2열 레이아웃 개선)
  │
  └── 액션 버튼 (답안수정/합격예측 — 서브탭 밖, 기존 유지)
```

### Lazy Loading 전략

```typescript
// AnalysisSubTabs.tsx — 선택한 탭만 렌더링 (API 호출 최적화)
const [activeTab, setActiveTab] = useState<'score' | 'exam' | 'answer'>('score');

// 탭 전환 시 해당 탭의 컴포넌트만 마운트
// → 미선택 탭의 API 호출을 지연시켜 초기 로드 속도 개선
{activeTab === 'score' && <MyScoreTab />}
{activeTab === 'exam' && <ExamAnalysisTab />}
{activeTab === 'answer' && <AnswerReviewTab />}
```

---

## 6. 페이지 레이아웃 — 서브탭 그룹화

### 6.1 문제점: 다수 섹션 세로 나열

분석 기능을 한 페이지에 세로로 나열하면:
- 스크롤이 과도하게 길어짐 (모바일에서 특히 심각)
- 사용자가 원하는 정보를 찾기 어려움
- 첫 화면에 핵심 정보가 묻힘

### 6.2 해결: 서브탭(필터 버튼) 그룹화

**기존 글로벌 탭**(응시정보입력 | 내 성적분석 | 합격예측 | 댓글)은 유지하되,
**`/exam/result` 페이지 내부**에 3개 서브탭을 두어 관련 기능끼리 묶는다.

> **참고**: 경쟁사(경단기·해커스·에듀윌)도 분석 탭 내에서 세부 그룹핑 사용.
> NN/g 연구: "탭은 3~5개가 이상적, 관련 데이터는 같은 뷰에 배치"

### 6.3 서브탭 구성

```
/exam/result 페이지

┌──────────────────────────────────────────────────────────────────┐
│  [응시정보 입력]  [ 내 성적 분석 ]  [합격 컷/경쟁자]  [실시간 댓글]  │  ← 글로벌 탭 (기존)
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌─ 서브탭 (필 버튼 스타일) ──────────────────────────────────┐ │
│  │                                                              │ │
│  │  [ 내 성적 ]  [ 시험 분석 ]  [ 정오표 ]                      │ │
│  │    (활성)                                                    │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─ 서브탭 콘텐츠 영역 ────────────────────────────────────────┐ │
│  │                                                              │ │
│  │  (선택한 서브탭에 해당하는 2~3개 섹션만 표시)                 │ │
│  │                                                              │ │
│  └──────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 6.4 서브탭별 기능 배치

#### 서브탭 1: 내 성적 (기본 활성)

> 사용자가 가장 먼저, 가장 자주 확인하는 핵심 정보

```
┌─────────────────────────────────────────────┐
│ [A] 전체 성적 요약 테이블                    │
│     과목별 내 점수, 석차, 전체 평균,          │
│     최고점, 상위평균                          │
├─────────────────────────────────────────────┤
│ [J] 정답 변경 영향 분석 ⚡                   │
│     가답안→확정답안 변경 시에만 표시           │
│     (변경 없으면 안내 문구만)                  │
├─────────────────────────────────────────────┤
│ [K] 참여 현황                                │
│     현재 참여자 수 + 내 석차/백분위            │
└─────────────────────────────────────────────┘
```

- **섹션 수**: 2~3개 (J는 조건부)
- **첫 화면에 보이는 것**: A 성적 요약 테이블 전체
- **재방문 가치**: K 참여자 수·석차가 매번 달라져서 재접속 유도

#### 서브탭 2: 시험 분석

> 이번 시험의 전체적인 난이도와 응시자 분포

```
┌─────────────────────────────────────────────┐
│ [B] 과목별 비교 차트                         │
│     내 점수 vs 전체 평균 그룹 막대            │
├─────────────────────────────────────────────┤
│ [C] 오답률 Top5                              │
│     과목 드롭다운 + 오답률 높은 문항 5개      │
├─────────────────────────────────────────────┤
│ [F] 점수대별 인원 분포                       │
│     히스토그램 + 내 위치 강조                 │
└─────────────────────────────────────────────┘
```

- **섹션 수**: 3개
- **공통 테마**: "다른 사람들과 비교" — 전체 응시자 기준 통계

#### 서브탭 3: 정오표

> 문항별 정답률과 내 답안 리뷰

```
┌─────────────────────────────────────────────┐
│ ⑤ CorrectRateChart (기존)                    │
│     과목별 문항 정답률 바차트 (기존 유지)      │
├─────────────────────────────────────────────┤
│ ⑥ AnswerSheet (기존 → 2열 레이아웃 개선)     │
│     과목 드롭다운 + 2열 레이아웃 + 과목 요약  │
└─────────────────────────────────────────────┘
```

- **섹션 수**: 2개 (기존 1 + 기존 개선 1)
- **공통 테마**: "내가 어디서 틀렸나?" — 문항별 정답률 + 개인 오답 리뷰

### 6.5 서브탭 UI 스펙

#### 서브탭 버튼 스타일 (필 버튼)

```
비활성:  bg-white  border border-slate-200  text-slate-600  rounded-full  px-4 py-2
활성:    bg-slate-900  text-white  rounded-full  px-4 py-2
호버:    bg-slate-100  text-slate-800  rounded-full  px-4 py-2
```

```
┌────────────────────────────────────────────────────────────────────┐
│                                                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                          │
│  │ ● 내 성적 │ │ 시험 분석 │ │  정오표   │                          │
│  └──────────┘ └──────────┘ └──────────┘                          │
│   (bg-900)     (border)     (border)                              │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### 동작 방식

| 항목 | 설명 |
|------|------|
| 기본 활성 탭 | "내 성적" (첫 번째) |
| 전환 방식 | 클릭 시 콘텐츠 즉시 전환 (클라이언트 사이드 상태, URL 변경 없음) |
| 모바일 | 3개 버튼이 한 줄에 배치 (모바일에서도 충분히 수용) |
| 전환 애니메이션 | 없음 (즉시 전환, 불필요한 지연 방지) |
| 구현 | React `useState` 또는 `shadcn/ui Tabs` 컴포넌트 활용 |

#### 기존 ExamTabNavigation과의 차이

| 항목 | 글로벌 탭 (ExamTabNavigation) | 서브탭 (신규) |
|------|---------------------------|-------------|
| 위치 | 페이지 최상단 | `/exam/result` 콘텐츠 영역 내부 |
| 스타일 | 밑줄(border-bottom) 탭 | 필(pill) 버튼 |
| 라우팅 | Next.js Link (URL 변경) | 클라이언트 상태 (URL 유지) |
| 역할 | 페이지 전환 | 동일 페이지 내 콘텐츠 필터링 |

### 6.6 장점

| 기존 (세로 나열) | 개선 (3개 서브탭) |
|---------------------|-----------------|
| 모든 섹션 세로 나열 | 한 탭에 2~3개 섹션만 |
| 첫 화면에 A만 보임 | 첫 화면에 A+J+K 핵심 정보 |
| 원하는 정보 찾기 어려움 | 3개 카테고리 중 선택 |
| 모바일에서 끝없는 스크롤 | 모바일에서도 적절한 길이 |
| 모든 데이터 동시 로드 | **Lazy loading**: 선택한 탭만 API 호출 |

---

## 7. 기존 코드 활용 포인트

| 기존 코드 | 경로 | 활용 방안 |
|----------|------|---------|
| **기존 page.tsx 전체** | `src/app/exam/result/page.tsx` | **구조 변경**: 기존 inline 섹션들을 서브탭 구조로 재배치 |
| `CorrectRateChart` 컴포넌트 | `src/components/result/CorrectRateChart.tsx` | **유지**: 서브탭3(정오표)으로 이동만 |
| `AnswerSheet` 컴포넌트 | `src/components/result/AnswerSheet.tsx` | **수정**: 2열 레이아웃으로 개선 (summary 유지) |
| `getCorrectRateRows()` | `src/lib/correct-rate.ts` | 문항별 정답률 데이터 (C 기능에 활용) |
| `toCorrectRateDifficultyLevel()` | `src/lib/correct-rate.ts` | 난이도 레벨 변환 (AnswerSheet 표시에 활용) |
| 10점 구간 버킷 분포 | `/api/stats/route.ts` | 점수대별 인원 분포 (F 기능에 재활용) |
| `UserAnswer.selectedAnswer` | DB | 선지별 선택 비율 쿼리 데이터 소스 (C에 활용) |
| `SubjectScore.rawScore` | DB | 과목별 최고점/상위평균 산출 (A에 활용) |
| `RescoreEvent` + `RescoreDetail` | DB | 정답 변경 영향 분석 (J) — 변경 전/후 점수·석차 이미 저장됨 |
| `AnswerKeyLog` | DB | 정답키 변경 이력 (J) — 문항별 oldAnswer/newAnswer |
| `rescoreExam()` | `src/lib/scoring.ts` | 재채점 로직 (J) — changedQuestions 메타데이터 활용 |
| `PassCutSnapshot` | DB | 참여 현황 (K) — 관리자 릴리스 시점 참여자 수 참고 |
| `/api/result` 순위 계산 SQL | `src/app/api/result/route.ts` | 석차 계산 로직 (K) 재활용 |

---

## 8. 우선순위 및 개발 순서

| 순서 | 기능 | 유형 | 우선순위 | 난이도 | 예상 작업량 |
|------|------|------|---------|-------|-----------|
| 0 | **서브탭 구조 셋업** | 구조변경 | 높음 | 중 | AnalysisSubTabs + 3개 탭 컨테이너 + page.tsx 리팩토링 |
| 1 | [A] 전체 성적 요약 (확장) | 기존수정 | 높음 | 중 | 기존 cards+table 통합 + 전체 평균/최고점/상위% API 추가 |
| 2 | [B] 과목별 비교 차트 | 기존수정 | 높음 | 낮 | 기존 바차트에 평균 막대 추가 (그룹 BarChart) |
| 3 | ⑥ AnswerSheet 2열 개선 | 기존수정 | 높음 | 낮 | 기존 컴포넌트 수정 (2열 + 드롭다운) |
| 4 | [J] 정답 변경 영향 분석 | **신규** | 높음 | 낮 | 기존 RescoreDetail 조회만 — 추가 계산 불필요 |
| 5 | [K] 참여 현황 | **신규** | 높음 | 낮 | 기존 /api/result 데이터 표시만 — 추가 DB/API 불필요 |
| 6 | [C] 오답률 Top5 | **신규** | 높음 | 중 | 신규 API + 오답률 쿼리 |
| 7 | [F] 점수대별 분포 | **신규** | 중 | 낮 | 기존 stats 쿼리 재활용 |

---

## 9. 주의사항

1. **모집단 분리**: 공채/경행경채는 반드시 별도 모집단으로 통계 산출 (혼용 금지)
2. **캐싱**: 문항별 정답률은 기존 120초 캐시 활용, 상위평균 등 신규 통계도 캐시 적용 권장
3. **반응형**: 모바일에서 테이블·차트가 깨지지 않도록 스크롤 또는 카드 레이아웃 대응
4. **정답키 변경 대응**: 가답안→확정답안 변경 시 `invalidateCorrectRateCache()` 호출로 통계 자동 갱신
5. **최소 참여인원**: 통계가 의미 있으려면 최소 10명 이상 참여 시 표시, 미달 시 "데이터 수집 중" 안내
6. **정답 변경 분석 [J] 조건부 표시**: `RescoreEvent`가 없으면 "아직 정답 변경이 없습니다" 안내 문구만 표시. 가답안 기간에는 이 섹션이 비활성 상태
