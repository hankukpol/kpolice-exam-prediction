generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  USER
  ADMIN
}

enum ExamType {
  PUBLIC
  CAREER
}

enum Gender {
  MALE
  FEMALE
}

enum BonusType {
  NONE
  VETERAN_5
  VETERAN_10
  HERO_3
  HERO_5
}

enum DifficultyRatingLevel {
  VERY_EASY
  EASY
  NORMAL
  HARD
  VERY_HARD
}

enum PassCutSnapshotStatus {
  READY
  COLLECTING_LOW_PARTICIPATION
  COLLECTING_UNSTABLE
  COLLECTING_MISSING_APPLICANT_COUNT
  COLLECTING_INSUFFICIENT_SAMPLE
}

model User {
  id          Int          @id @default(autoincrement())
  name        String
  phone       String       @unique
  password    String
  role        Role         @default(USER)
  createdAt   DateTime     @default(now())
  submissions Submission[]
  comments    Comment[]
  answerKeyLogs AnswerKeyLog[]
  rescoreEventsCreated RescoreEvent[]
  passCutReleasesCreated PassCutRelease[]
  rescoreDetails RescoreDetail[]
  finalPredictions FinalPrediction[]
  submissionLogs SubmissionLog[]
}

model Exam {
  id          Int          @id @default(autoincrement())
  name        String
  year        Int
  round       Int
  examDate    DateTime
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  answerKeys  AnswerKey[]
  answerKeyLogs AnswerKeyLog[]
  submissions Submission[]
  comments    Comment[]
  rescoreEvents RescoreEvent[]
  passCutReleases PassCutRelease[]
  quotas  ExamRegionQuota[]

  @@unique([year, round])
}

model Region {
  id               Int                @id @default(autoincrement())
  name             String             @unique
  isActive         Boolean            @default(true)
  submissions      Submission[]
  passCutSnapshots PassCutSnapshot[]
  quotas           ExamRegionQuota[]
}

model ExamRegionQuota {
  id                   Int      @id @default(autoincrement())
  examId               Int
  regionId             Int
  recruitCount         Int      // 공채 모집인원
  recruitCountCareer   Int      // 경행경채 모집인원
  applicantCount       Int?     // 공채 출원인원
  applicantCountCareer Int?     // 경행경채 출원인원
  examNumberStart      String?  // 유효 응시번호 시작 (예: "00001")
  examNumberEnd        String?  // 유효 응시번호 끝 (예: "00300")
  exam                 Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  region               Region   @relation(fields: [regionId], references: [id], onDelete: Restrict)

  @@unique([examId, regionId])
  @@map("exam_region_quotas")
}

model Subject {
  id               Int            @id @default(autoincrement())
  name             String
  questionCount    Int
  pointPerQuestion Float
  maxScore         Float
  examType         ExamType
  answerKeys       AnswerKey[]
  answerKeyLogs    AnswerKeyLog[]
  userAnswers      UserAnswer[]
  subjectScores    SubjectScore[]
  difficultyRatings DifficultyRating[]

  @@unique([name, examType])
}

model AnswerKey {
  id             Int     @id @default(autoincrement())
  examId         Int
  subjectId      Int
  questionNumber Int
  correctAnswer  Int
  isConfirmed    Boolean @default(false)
  exam           Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject        Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([examId, subjectId, questionNumber])
}

model AnswerKeyLog {
  id             Int      @id @default(autoincrement())
  examId         Int
  examType       ExamType
  subjectId      Int
  questionNumber Int
  oldAnswer      Int?
  newAnswer      Int
  changedBy      Int
  createdAt      DateTime @default(now())
  exam           Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject        Subject  @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  admin          User     @relation(fields: [changedBy], references: [id], onDelete: Restrict)

  @@index([examId, examType, createdAt])
  @@index([subjectId, questionNumber])
}

model Submission {
  id            Int            @id @default(autoincrement())
  examId        Int
  userId        Int
  regionId      Int
  examType      ExamType
  gender        Gender
  examNumber    String
  totalScore    Float
  bonusType     BonusType      @default(NONE)
  bonusRate     Float          @default(0)
  finalScore    Float
  editCount         Int            @default(0)
  isSuspicious      Boolean        @default(false)
  suspiciousReason  String?        @db.Text
  submitDurationMs  Int?           // 페이지 로드 → 제출까지 소요시간 (밀리초)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @default(now()) @updatedAt
  exam          Exam           @relation(fields: [examId], references: [id], onDelete: Restrict)
  user          User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  region        Region         @relation(fields: [regionId], references: [id], onDelete: Restrict)
  userAnswers   UserAnswer[]
  subjectScores SubjectScore[]
  difficultyRatings DifficultyRating[]
  rescoreDetails RescoreDetail[]
  finalPrediction FinalPrediction?
  logs          SubmissionLog[]

  @@unique([userId, examId])
  @@unique([examId, regionId, examNumber])
  @@index([examId, regionId, examType])
  @@index([examId, examType, finalScore])
  @@index([examId, regionId, examType, isSuspicious])
}

model UserAnswer {
  id             Int        @id @default(autoincrement())
  submissionId   Int
  subjectId      Int
  questionNumber Int
  selectedAnswer Int
  isCorrect      Boolean
  submission     Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  subject        Subject    @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([submissionId, subjectId, questionNumber])
}

model SubjectScore {
  id           Int        @id @default(autoincrement())
  submissionId Int
  subjectId    Int
  rawScore     Float
  isFailed     Boolean
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  subject      Subject    @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([submissionId, subjectId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  examId    Int
  userId    Int
  content   String   @db.Text
  createdAt DateTime @default(now())
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([examId, createdAt])
  @@index([userId])
}

model SiteSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @default(now()) @updatedAt
}

model Notice {
  id        Int      @id @default(autoincrement())
  title     String
  content   String   @db.Text
  isActive  Boolean  @default(true)
  priority  Int      @default(0)
  startAt   DateTime?
  endAt     DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Faq {
  id        Int      @id @default(autoincrement())
  question  String
  answer    String   @db.Text
  isActive  Boolean  @default(true)
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Banner {
  id          Int      @id @default(autoincrement())
  zone        String
  imageUrl    String?
  linkUrl     String?
  altText     String   @default("")
  htmlContent String?  @db.Text
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([zone, isActive])
}

model EventSection {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  imageUrl    String?
  linkUrl     String?
  linkText    String?
  bgColor     String   @default("#ffffff")
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  startAt     DateTime?
  endAt       DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

model DifficultyRating {
  id           Int        @id @default(autoincrement())
  submissionId Int
  subjectId    Int
  rating       DifficultyRatingLevel
  createdAt    DateTime   @default(now())
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  subject      Subject    @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([submissionId, subjectId])
  @@index([subjectId, rating])
}

// One rescore run metadata.
model RescoreEvent {
  id        Int      @id @default(autoincrement())
  examId    Int
  examType  ExamType
  reason    String?  @db.Text
  summary   String   @db.Text
  createdBy Int
  createdAt DateTime @default(now())
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  admin     User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  details   RescoreDetail[]

  @@index([examId, createdAt])
}

// Per-submission score deltas recorded for a rescore event.
model RescoreDetail {
  id             Int      @id @default(autoincrement())
  rescoreEventId Int
  submissionId   Int
  userId         Int
  oldTotalScore  Float
  newTotalScore  Float
  oldFinalScore  Float
  newFinalScore  Float
  oldRank        Int?
  newRank        Int?
  scoreDelta     Float
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  rescoreEvent   RescoreEvent @relation(fields: [rescoreEventId], references: [id], onDelete: Cascade)
  submission     Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rescoreEventId, submissionId])
  @@index([userId, isRead])
  @@index([submissionId])
}

// 1st~4th pass-cut release snapshots.
model PassCutRelease {
  id               Int      @id @default(autoincrement())
  examId           Int
  releaseNumber    Int
  releasedAt       DateTime @default(now())
  participantCount Int
  createdBy        Int
  memo             String?  @db.Text
  exam             Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  admin            User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  snapshots        PassCutSnapshot[]

  @@unique([examId, releaseNumber])
  @@index([examId])
}

// Region + examType row captured at release time.
model PassCutSnapshot {
  id                  Int      @id @default(autoincrement())
  passCutReleaseId    Int
  regionId            Int
  examType            ExamType
  status              PassCutSnapshotStatus @default(READY)
  statusReason        String?  @db.Text
  applicantCount      Int?
  targetParticipantCount Int?
  coverageRate        Float?
  stabilityScore      Float?
  participantCount    Int
  recruitCount        Int
  averageScore        Float?
  oneMultipleCutScore Float?
  sureMinScore        Float?
  likelyMinScore      Float?
  possibleMinScore    Float?
  passCutRelease      PassCutRelease @relation(fields: [passCutReleaseId], references: [id], onDelete: Cascade)
  region              Region         @relation(fields: [regionId], references: [id], onDelete: Restrict)

  @@unique([passCutReleaseId, regionId, examType])
  @@index([passCutReleaseId])
}

// Reserved for post-written/final prediction phase.
model FinalPrediction {
  id             Int      @id @default(autoincrement())
  submissionId   Int      @unique
  userId         Int
  fitnessScore   Float?
  interviewScore Float?
  interviewGrade String?
  finalScore     Float?
  finalRank      Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  submission     Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// 제출/수정 감사 로그
model SubmissionLog {
  id               Int        @id @default(autoincrement())
  submissionId     Int
  userId           Int
  action           String     // "CREATE" | "UPDATE"
  ipAddress        String?
  submitDurationMs Int?
  changedFields    String?    @db.Text  // JSON: 변경된 필드 목록
  createdAt        DateTime   @default(now())
  submission       Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([userId, createdAt])
}
